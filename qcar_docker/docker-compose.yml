services:
  ros:
    build: .
    image: qcar_docker-ros

    # GPU acceleration for Gazebo rendering
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu, compute, utility]

    ports:
      - "9090:9090"  # rosbridge
      - "7000:7000"  # est√°tico (URDF/meshes)
      - "8080:8080"  # WVS (solo si lo activas)
      - "10000:10000"  # ROS-TCP-Endpoint for Unity
      - "11345:11345" # Gazebo master (optional)
    environment:
      # NVIDIA GPU environment variables
      - NVIDIA_VISIBLE_DEVICES=all
      - NVIDIA_DRIVER_CAPABILITIES=all

      # X11 forwarding to Windows VcXsrv
      - DISPLAY=192.168.100.119:0.0
      - LIBGL_ALWAYS_INDIRECT=0      # Use direct rendering (GPU)
      - QT_X11_NO_MITSHM=1           # Fix Qt X11 issues

      # ROS/Gazebo configuration
      - CORS_ALLOW_ORIGIN=http://localhost:3000,http://127.0.0.1:3000,http://${EXPOSED_IP:-192.168.56.1}:3000
      - ENABLE_JSP=1
      - ENABLE_ROSAPI=1
      - ENABLE_WVS=1
      - ENABLE_TURTLESIM=1
      - ENABLE_GAZEBO=1
      - ENABLE_DUMMY_CAMERAS=0       # Disable - use real Gazebo cameras with X11
      - ENABLE_UNITY_TCP=1           # Enable ROS-TCP-Endpoint for Unity
      - UNITY_TCP_PORT=10000         # Port for Unity connection
      - GAZEBO_WORLD=/ros2_ws/src/qcar_bringup/worlds/simple_track.world
      - IP_CONFIG_PATH=/config/ip_config.json
    volumes:
      - ../config/ip_config.json:/config/ip_config.json:ro
